name: Auto Fetch NSE Option Chains

on:
  schedule:
    - cron: "35 14 * * 1-5"  # 20:05 IST => 14:35 UTC, Mon-Fri
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run fetch script
        run: |
          python examples/real_fetch_example.py --symbols NIFTY BANKNIFTY

      - name: Show outputs
        run: |
          ls -la data/option_chain_raw || true
          tail -n 5 data/option_chain_raw/* || true

      - name: Commit outputs (if any)
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: actions@github.com
        run: |
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git add data/option_chain_raw || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-update option chains: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
          fi
          
